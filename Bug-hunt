#!/usr/bin/env bash
# Bug-hunt runner: installs essentials, privacy/security tools, sudo, and attempts superuser mode.
# Safeguards: All installs are best-effort, no destructive changes, sudoers config is validated.
set -euo pipefail
IFS=$'\n\t'

BLUE='\033[1;34m'; GREEN='\033[1;32m'; YELLOW='\033[1;33m'; RED='\033[1;31m'; RESET='\033[0m'

# Print banner
banner() {
  echo -e "${BLUE}===========================================${RESET}"
  echo -e "${BLUE}          Bug-hunt Tool v1.3               ${RESET}"
  echo -e "${BLUE}===========================================${RESET}"
}

# Detect package manager
pkg_manager() {
  if command -v pkg >/dev/null 2>&1; then echo pkg
  elif command -v apt >/dev/null 2>&1; then echo apt
  elif command -v dnf >/dev/null 2>&1; then echo dnf
  elif command -v pacman >/dev/null 2>&1; then echo pacman
  else echo ""; fi
}

# Install sudo if missing and configure minimal sudoers for firewall tools
ensure_sudo() {
  local PM; PM=$(pkg_manager); [ -z "$PM" ] && return 0
  if ! command -v sudo >/dev/null 2>&1; then
    echo -e "${YELLOW}[*] Installing sudo...${RESET}"
    case "$PM" in
      apt|dnf) $PM install -y sudo || true ;;
      pacman) $PM -S --noconfirm sudo || true ;;
      pkg) $PM install -y sudo || true ;;
    esac
  fi
  if command -v sudo >/dev/null 2>&1; then
    # Only allow ufw/iptables for current user, validate drop-in
    local USERNAME; USERNAME=$(id -un)
    local DROPIN="/etc/sudoers.d/bug_hunt"
    printf "%s ALL=(root) NOPASSWD: /usr/sbin/ufw, /usr/sbin/iptables, /sbin/iptables\n" "$USERNAME" | sudo tee "$DROPIN" >/dev/null || true
    if sudo visudo -cf "$DROPIN" >/dev/null 2>&1; then
      sudo chmod 440 "$DROPIN" || true
      echo -e "${GREEN}[✓] Sudo configured for ufw/iptables without password for $USERNAME.${RESET}"
    else
      sudo rm -f "$DROPIN" || true
      echo -e "${YELLOW}[!] sudoers validation failed; not applying auto-config.${RESET}"
    fi
    sudo -v || true
  fi
}

# Try to become super user, update prompt if successful
try_superuser() {
  if [ "${EUID:-$(id -u)}" -ne 0 ]; then
    echo -e "${YELLOW}[*] Not root. Trying to elevate...${RESET}"
    if command -v tsu >/dev/null 2>&1; then
      tsu || echo -e "${YELLOW}[!] tsu failed, continuing without root.${RESET}"
    elif command -v sudo >/dev/null 2>&1; then
      sudo -v || echo -e "${YELLOW}[!] sudo failed, continuing without root.${RESET}"
    else
      echo -e "${YELLOW}[!] No elevation tool available.${RESET}"
    fi
  fi
  if [ "${EUID:-$(id -u)}" -eq 0 ]; then
    export PS1='[SUPERUSER] \u@\h:\w\$ '
    echo -e "${GREEN}[✓] Superuser mode active. Prompt updated.${RESET}"
  else
    echo -e "${YELLOW}[!] Still running as regular user.${RESET}"
  fi
}

# Install essential tools
install_essentials() {
  local PM; PM=$(pkg_manager)
  if [ -z "$PM" ]; then echo -e "${RED}[✗] No supported package manager found${RESET}"; return 1; fi
  echo -e "${YELLOW}[*] Updating packages...${RESET}"; $PM update -y || true
  echo -e "${YELLOW}[*] Upgrading packages...${RESET}"; $PM upgrade -y || true
  local pkgs=(git curl wget)
  case "$PM" in
    apt|dnf) pkgs+=(python3 python3-pip) ;;
    pacman) pkgs+=(python python-pip) ;;
    pkg) pkgs+=(python python-pip) ;;
  esac
  # Termux extras
  if command -v pkg >/dev/null 2>&1; then pkgs+=(tsu termux-tools termux-api); fi
  for p in "${pkgs[@]}"; do $PM install -y "$p" || echo -e "${YELLOW}[!] Failed to install $p${RESET}"; done
}

# Install privacy tools (Tor, proxychains)
install_privacy_tools() {
  local PM; PM=$(pkg_manager); [ -z "$PM" ] && return 0
  echo -e "${YELLOW}[*] Installing privacy tools (HideMyIP: tor, proxychains)...${RESET}"
  case "$PM" in
    apt) $PM install -y tor proxychains4 || true ;;
    dnf) $PM install -y tor proxychains-ng || true ;;
    pacman) $PM -S --noconfirm tor proxychains-ng || true ;;
    pkg) $PM install -y tor || true ;; # proxychains may be unavailable on Termux
  esac
  # Proxychains config
  if [ -f /etc/proxychains.conf ]; then
    sudo sed -i 's/^#\s*dynamic_chain/dynamic_chain/' /etc/proxychains.conf || true
    sudo sed -i 's/^#\s*quiet_mode/quiet_mode/' /etc/proxychains.conf || true
    # ensure a socks5 entry (tor default)
    if ! grep -q '^socks5\s\+127.0.0.1\s\+9050' /etc/proxychains.conf 2>/dev/null; then
      echo 'socks5  127.0.0.1 9050' | sudo tee -a /etc/proxychains.conf >/dev/null || true
    fi
  fi
  echo -e "${GREEN}[✓] Privacy tools processed.${RESET}"
}

# Install security tools (firewall, anti-malware)
install_security_tools() {
  local PM; PM=$(pkg_manager); [ -z "$PM" ] && return 0
  echo -e "${YELLOW}[*] Installing security tools (firewall, antispy, antimalware)...${RESET}"
  case "$PM" in
    apt|dnf) $PM install -y ufw iptables || true ;;
    pacman) $PM -S --noconfirm ufw iptables || true ;;
    pkg) $PM install -y iptables || true ;;
  esac
  # Enable firewall
  if command -v ufw >/dev/null 2>&1; then
    sudo ufw default deny incoming || true
    sudo ufw default allow outgoing || true
    sudo ufw allow 22/tcp || true
    sudo ufw --force enable || true
    echo -e "${GREEN}[✓] UFW firewall enabled.${RESET}"
  elif command -v iptables >/dev/null 2>&1; then
    sudo iptables -F || true
    sudo iptables -P INPUT DROP || true
    sudo iptables -P FORWARD DROP || true
    sudo iptables -P OUTPUT ACCEPT || true
    sudo iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT || true
    sudo iptables -A INPUT -i lo -j ACCEPT || true
    sudo iptables -A INPUT -p tcp --dport 22 -j ACCEPT || true
    echo -e "${GREEN}[✓] iptables rules applied.${RESET}"
  fi
  # Anti-malware / anti-spy (CLI)
  case "$PM" in
    apt) $PM install -y clamav rkhunter chkrootkit || true ;;
    dnf) $PM install -y clamav clamav-update rkhunter chkrootkit || true ;;
    pacman) $PM -S --noconfirm clamav rkhunter chkrootkit || true ;;
    pkg) : ;; # often unavailable in Termux
  esac
  echo -e "${GREEN}[✓] Security tools processed.${RESET}"
}

banner
install_essentials
ensure_sudo
try_superuser
install_privacy_tools
install_security_tools

echo -e "${GREEN}[✓] Bug-hunt privacy/security setup complete.${RESET}"
echo -e "${YELLOW}[*] To route commands via Tor: run 'proxychains4 <cmd>' (apt) or 'proxychains <cmd>' (ng).${RESET}"
